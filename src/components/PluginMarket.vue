<template>
  <div class="plugin-market">
    <el-alert
      title="üîå Êèí‰ª∂Â∏ÇÂú∫ÔºöÊó†ÈôêÊâ©Â±ïÊÇ®ÁöÑËá™Â™í‰ΩìÂ∑•ÂÖ∑ËÉΩÂäõ"
      type="info"
      :closable="false"
      style="margin-bottom: 20px"
    />

    <!-- Â∏ÇÂú∫ÁªüËÆ° -->
    <div class="market-stats">
      <el-row :gutter="20">
        <el-col :span="6">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="icon">üì¶</div>
              <div class="data">
                <div class="number">{{ totalPlugins }}</div>
                <div class="label">ÊÄªÊèí‰ª∂Êï∞</div>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="icon">‚¨áÔ∏è</div>
              <div class="data">
                <div class="number">{{ installedPlugins }}</div>
                <div class="label">Â∑≤ÂÆâË£Ö</div>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="icon">‚≠ê</div>
              <div class="data">
                <div class="number">{{ avgRating }}</div>
                <div class="label">Âπ≥ÂùáËØÑÂàÜ</div>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="6">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="icon">üî•</div>
              <div class="data">
                <div class="number">{{ trendingPlugins }}</div>
                <div class="label">Êú¨Âë®ÁÉ≠Èó®</div>
              </div>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- ÊêúÁ¥¢ÂíåÁ≠õÈÄâ -->
    <div class="search-section">
      <el-card>
        <el-row :gutter="20" align="middle">
          <el-col :span="10">
            <el-input
              v-model="searchQuery"
              placeholder="ÊêúÁ¥¢Êèí‰ª∂..."
              :prefix-icon="Search"
              clearable
            />
          </el-col>
          <el-col :span="5">
            <el-select v-model="selectedCategory" placeholder="ÈÄâÊã©ÂàÜÁ±ª" clearable>
              <el-option label="ÂÜÖÂÆπÂàõ‰Ωú" value="content" />
              <el-option label="Êï∞ÊçÆÂàÜÊûê" value="analytics" />
              <el-option label="Âπ≥Âè∞ÈõÜÊàê" value="platform" />
              <el-option label="ÊïàÁéáÂ∑•ÂÖ∑" value="productivity" />
              <el-option label="AIÂ¢ûÂº∫" value="ai" />
            </el-select>
          </el-col>
          <el-col :span="4">
            <el-select v-model="priceFilter" placeholder="‰ª∑Ê†ºÁ≠õÈÄâ">
              <el-option label="ÂÖ®ÈÉ®" value="all" />
              <el-option label="ÂÖçË¥π" value="free" />
              <el-option label="‰ªòË¥π" value="premium" />
            </el-select>
          </el-col>
          <el-col :span="5">
            <el-select v-model="sortBy" placeholder="ÊéíÂ∫èÊñπÂºè">
              <el-option label="ÁÉ≠Èó®Á®ãÂ∫¶" value="popular" />
              <el-option label="ËØÑÂàÜÊúÄÈ´ò" value="rating" />
              <el-option label="ÊúÄÊñ∞ÂèëÂ∏É" value="newest" />
              <el-option label="‰∏ãËΩΩÈáè" value="downloads" />
            </el-select>
          </el-col>
        </el-row>
      </el-card>
    </div>

    <!-- Êèí‰ª∂Â±ïÁ§∫ -->
    <div class="plugins-grid">
      <el-row :gutter="20">
        <el-col v-for="plugin in filteredPlugins" :key="plugin.id" :span="8">
          <el-card class="plugin-card" :body-style="{ padding: '0px' }" :class="{ 'premium-plugin': plugin.type === 'premium' }">
            <div class="plugin-header">
              <img :src="plugin.icon" class="plugin-icon" />
              <div class="plugin-info">
                <h3>{{ plugin.name }}</h3>
                <p class="author">by {{ plugin.author }}</p>
              </div>
              <div class="plugin-badges">
                <el-tag v-if="plugin.type === 'free'" type="success" size="small">ÂÖçË¥π</el-tag>
                <el-tag v-else type="warning" size="small">‰ªòË¥π</el-tag>
                <el-tag v-if="plugin.licenseStatus?.status === 'trial'" type="info" size="small">ËØïÁî®‰∏≠</el-tag>
              </div>
            </div>
            
            <div class="plugin-body">
              <p class="description">{{ plugin.description }}</p>
              
              <!-- ‰ª∑Ê†º‰ø°ÊÅØ -->
              <div v-if="plugin.type === 'premium'" class="plugin-price">
                <span class="price">¬•{{ plugin.price }}</span>
                <span class="trial-info">ÊîØÊåÅ7Â§©ÂÖçË¥πËØïÁî®</span>
              </div>
              
              <div class="plugin-stats">
                <div class="stat">
                  <el-icon><Star /></el-icon>
                  <span>{{ plugin.rating }}</span>
                </div>
                <div class="stat">
                  <el-icon><Download /></el-icon>
                  <span>{{ plugin.downloads }}</span>
                </div>
                <div class="stat">
                  <el-icon><User /></el-icon>
                  <span>{{ plugin.users }}</span>
                </div>
              </div>

              <div class="categories">
                <el-tag 
                  v-for="category in plugin.categories" 
                  :key="category" 
                  size="mini" 
                  class="category-tag"
                >
                  {{ category }}
                </el-tag>
              </div>
              
              <!-- ‰ΩøÁî®ÈôêÂà∂ -->
              <div v-if="plugin.limitations && plugin.type === 'free'" class="plugin-limitations">
                <el-text size="small" type="info">
                  ÊØèÊó•ÈôêÁî®{{ plugin.limitations.dailyUsage }}Ê¨°
                </el-text>
              </div>
            </div>

            <div class="plugin-footer">
              <template v-if="plugin.status === 'available'">
                <el-button 
                  v-if="plugin.type === 'free'"
                  type="primary" 
                  size="small" 
                  @click="installPlugin(plugin)"
                  :loading="installing === plugin.id"
                >
                  <el-icon><Download /></el-icon> 
                  ÂÆâË£Ö
                </el-button>
                
                <el-button 
                   v-if="plugin.type === 'premium'"
                   type="info" 
                   size="small" 
                   @click="startTrial(plugin)"
                   :loading="installing === plugin.id"
                 >
                   <el-icon><InfoFilled /></el-icon> 
                   ÂÖçË¥πËØïÁî®7Â§©
                 </el-button>
                
                <el-button 
                  v-if="plugin.type === 'premium'"
                  type="warning" 
                  size="small" 
                  @click="purchasePlugin(plugin)"
                  :loading="installing === plugin.id"
                >
                  Ë¥≠‰π∞ ¬•{{ plugin.price }}
                </el-button>
              </template>
              
              <template v-else-if="plugin.status === 'installed'">
                <el-button 
                  v-if="plugin.licenseStatus?.status === 'trial'"
                  type="warning" 
                  size="small" 
                  @click="purchasePlugin(plugin)"
                >
                  Ë¥≠‰π∞ËÆ∏ÂèØËØÅ
                </el-button>
                
                <el-button 
                  v-else-if="plugin.licenseStatus?.status === 'expired'"
                  type="danger" 
                  size="small" 
                  @click="renewPlugin(plugin)"
                >
                  Áª≠Ë¥π
                </el-button>
                
                <el-button 
                  v-else
                  type="success" 
                  size="small" 
                  disabled
                >
                  {{ plugin.type === 'free' ? 'Â∑≤ÂÆâË£Ö' : 'Â∑≤ÊøÄÊ¥ª' }}
                </el-button>
                
                <el-button 
                  type="warning" 
                  size="small" 
                  @click="uninstallPlugin(plugin)"
                  :loading="uninstalling === plugin.id"
                >
                  <el-icon><Delete /></el-icon> Âç∏ËΩΩ
                </el-button>
              </template>
              
              <template v-else>
                <el-button 
                  type="success" 
                  size="small" 
                  @click="updatePlugin(plugin)"
                >
                  <el-icon><Refresh /></el-icon> Êõ¥Êñ∞
                </el-button>
              </template>
              
              <el-button size="small" @click="viewPluginDetails(plugin)">
                ËØ¶ÊÉÖ
              </el-button>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- Êèí‰ª∂ËØ¶ÊÉÖÂØπËØùÊ°Ü -->
    <el-dialog v-model="detailDialogVisible" title="Êèí‰ª∂ËØ¶ÊÉÖ" width="600px">
      <div v-if="selectedPlugin" class="plugin-detail">
        <div class="detail-header">
          <img :src="selectedPlugin.icon" class="detail-icon" />
          <div class="detail-info">
            <h2>{{ selectedPlugin.name }}</h2>
            <p class="detail-author">‰ΩúËÄÖ: {{ selectedPlugin.author }}</p>
            <p class="detail-version">ÁâàÊú¨: {{ selectedPlugin.version }}</p>
          </div>
        </div>

        <div class="detail-content">
          <el-tabs v-model="activeDetailTab">
            <el-tab-pane label="ÊèèËø∞" name="description">
              <p>{{ selectedPlugin.longDescription }}</p>
              
              <h4>ÂäüËÉΩÁâπÊÄß</h4>
              <ul>
                <li v-for="feature in selectedPlugin.features" :key="feature">
                  ‚úì {{ feature }}
                </li>
              </ul>
            </el-tab-pane>

            <el-tab-pane label="ËØÑ‰ª∑" name="reviews">
              <div class="reviews">
                <div v-for="review in selectedPlugin.reviews" :key="review.id" class="review">
                  <div class="review-header">
                    <span class="reviewer">{{ review.user }}</span>
                    <el-rate v-model="review.rating" disabled size="small" />
                  </div>
                  <p>{{ review.comment }}</p>
                  <span class="review-date">{{ review.date }}</span>
                </div>
              </div>
            </el-tab-pane>

            <el-tab-pane label="ÁâàÊú¨ÂéÜÂè≤" name="changelog">
              <div class="changelog">
                <div v-for="version in selectedPlugin.changelog" :key="version.version" class="version">
                  <h5>{{ version.version }} ({{ version.date }})</h5>
                  <ul>
                    <li v-for="change in version.changes" :key="change">
                      ‚Ä¢ {{ change }}
                    </li>
                  </ul>
                </div>
              </div>
            </el-tab-pane>
          </el-tabs>
        </div>
      </div>
    </el-dialog>

    <!-- Ë¥≠‰π∞ÂØπËØùÊ°Ü -->
    <PluginPurchase
      v-if="showPurchaseDialog"
      :plugin="selectedPluginForPurchase"
      @purchase-complete="handlePurchaseComplete"
      @cancel="handlePurchaseCancel"
    />

    <!-- Â∑≤ÂÆâË£ÖÊèí‰ª∂ÁÆ°ÁêÜ -->
    <div class="installed-section">
      <el-card>
        <template #header>
          <span>üì¶ Â∑≤ÂÆâË£ÖÊèí‰ª∂</span>
          <el-button type="primary" size="small" @click="managePlugins" style="float: right">
            ÁÆ°ÁêÜÊèí‰ª∂
          </el-button>
        </template>
        
        <el-table :data="installedPluginList" style="width: 100%">
          <el-table-column prop="name" label="Êèí‰ª∂ÂêçÁß∞" />
          <el-table-column prop="version" label="ÁâàÊú¨" width="100" />
          <el-table-column prop="status" label="Áä∂ÊÄÅ" width="100">
            <template #default="{ row }">
              <el-tag :type="row.status === 'enabled' ? 'success' : 'warning'">
                {{ row.status === 'enabled' ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®' }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column label="Êìç‰Ωú" width="200">
            <template #default="{ row }">
              <el-button size="small" @click="togglePlugin(row)">
                {{ row.status === 'enabled' ? 'Á¶ÅÁî®' : 'ÂêØÁî®' }}
              </el-button>
              <el-button size="small" type="danger" @click="uninstallPlugin(row)">
                Âç∏ËΩΩ
              </el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-card>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Download, Delete, Refresh, View, Star, User, Calendar, Check, Box, Search, InfoFilled } from '@element-plus/icons-vue'
import pluginService from '../services/pluginService.js'
import { PLUGIN_CONFIG } from '../config/pluginSystem.config.js'
import PluginPurchase from './PluginPurchase.vue'

// Ê≥®ÂÜåÁªÑ‰ª∂
const components = {
  PluginPurchase
}

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const searchQuery = ref('')
const selectedCategory = ref('')
const priceFilter = ref('all')
const sortBy = ref('popular')
const detailDialogVisible = ref(false)
const activeDetailTab = ref('description')
const selectedPlugin = ref(null)
const installing = ref(null)
const uninstalling = ref(null)
const availablePlugins = ref([])

// Ë¥≠‰π∞ÂØπËØùÊ°ÜÁõ∏ÂÖ≥
const showPurchaseDialog = ref(false)
const selectedPluginForPurchase = ref(null)

// ÁªüËÆ°Êï∞ÊçÆ
const totalPlugins = ref(156)
const installedPlugins = ref(12)
const avgRating = ref(4.7)
const trendingPlugins = ref(8)

// Êèí‰ª∂Êï∞ÊçÆ
const plugins = ref([
  {
    id: 1,
    name: 'ÊäñÈü≥ÁÉ≠ÁÇπËøΩË∏™Âô®',
    author: 'AI Studio',
    version: '2.1.0',
    icon: 'https://via.placeholder.com/60x60/FF6B6B/FFFFFF?text=ÊäñÈü≥',
    description: 'ÂÆûÊó∂ÁõëÊéßÊäñÈü≥ÁÉ≠Ê¶úÔºåËá™Âä®Êé®ËçêÁÉ≠Èó®ËØùÈ¢ò',
    longDescription: 'ÊäñÈü≥ÁÉ≠ÁÇπËøΩË∏™Âô®ËÉΩÂ§üÂÆûÊó∂ÁõëÊéßÊäñÈü≥Âπ≥Âè∞ÁöÑÂÆûÊó∂ÁÉ≠Ê¶úÔºåÂåÖÊã¨ÁÉ≠Èó®ËØùÈ¢ò„ÄÅÁÉ≠Èó®Èü≥‰πê„ÄÅÁÉ≠Èó®ÊåëÊàòÁ≠â„ÄÇÂü∫‰∫éAIÁÆóÊ≥ïÂàÜÊûêË∂ãÂäøÔºå‰∏∫ÊÇ®ÁöÑÂÜÖÂÆπÂàõ‰ΩúÊèê‰æõÁÅµÊÑüÊù•Ê∫ê„ÄÇ',
    status: 'installed',
    type: 'free',
    rating: 4.8,
    downloads: 15420,
    users: 8900,
    categories: ['ÂÜÖÂÆπÂàõ‰Ωú', 'Êï∞ÊçÆÂàÜÊûê'],
    features: ['ÂÆûÊó∂ÁÉ≠Ê¶úÁõëÊéß', 'ËØùÈ¢òÊé®Ëçê', 'Ë∂ãÂäøÂàÜÊûê', '‰∏ÄÈîÆÁîüÊàêÈÄâÈ¢ò'],
    limitations: { dailyUsage: 50 },
    reviews: [
      { id: 1, user: 'Âàõ‰ΩúËÄÖÂ∞èÁéã', rating: 5, comment: 'ÈùûÂ∏∏ÂÆûÁî®ÔºåÂ∏ÆÊàëÊâæÂà∞‰∫ÜÂæàÂ§öÁÉ≠Èó®ÈÄâÈ¢òÔºÅ', date: '2024-01-15' },
      { id: 2, user: 'ËøêËê•Â∞èÊùé', rating: 4, comment: 'Êï∞ÊçÆÂæàÂáÜÁ°ÆÔºåÂ∞±ÊòØÁïåÈù¢ÂèØ‰ª•ÂÜç‰ºòÂåñ', date: '2024-01-10' }
    ],
    changelog: [
      { version: '2.1.0', date: '2024-01-20', changes: ['Êñ∞Â¢ûÈü≥‰πêÁÉ≠Ê¶ú', '‰ºòÂåñÊé®ËçêÁÆóÊ≥ï', '‰øÆÂ§çÂ∑≤Áü•bug'] },
      { version: '2.0.0', date: '2024-01-10', changes: ['ÂÖ®Êñ∞ÁïåÈù¢ËÆæËÆ°', 'Â¢ûÂä†Ë∂ãÂäøÈ¢ÑÊµã', 'ÊîØÊåÅÂ§öÂπ≥Âè∞Êï∞ÊçÆ'] }
    ]
  },
  {
    id: 2,
    name: 'Êô∫ËÉΩÂ≠óÂπïÁîüÊàêÂô®',
    author: 'Â≠óÂπïÂ§ßÂ∏à',
    version: '1.5.2',
    icon: 'https://via.placeholder.com/60x60/4ECDC4/FFFFFF?text=Â≠óÂπï',
    description: 'AIËá™Âä®ÁîüÊàêÁ≤æÁæéÂ≠óÂπïÔºåÊîØÊåÅÂ§öÁßçÊ†∑Âºè',
    longDescription: 'Âü∫‰∫éÂÖàËøõÁöÑËØ≠Èü≥ËØÜÂà´ÊäÄÊúØÔºåËá™Âä®‰∏∫ÊÇ®ÁöÑËßÜÈ¢ëÁîüÊàêÂáÜÁ°ÆÁöÑÂ≠óÂπï„ÄÇÊèê‰æõÂ§öÁßçÂ≠óÂπïÊ†∑ÂºèÊ®°ÊùøÔºåÊîØÊåÅËá™ÂÆö‰πâÂ≠ó‰Ωì„ÄÅÈ¢úËâ≤„ÄÅÂä®ÁîªÊïàÊûúÔºåËÆ©ÊÇ®ÁöÑËßÜÈ¢ëÊõ¥‰∏ì‰∏ö„ÄÇ',
    status: 'available',
    type: 'premium',
    price: 29.9,
    rating: 4.6,
    downloads: 12350,
    users: 6700,
    categories: ['ÂÜÖÂÆπÂàõ‰Ωú', 'AIÂ¢ûÂº∫'],
    features: ['Ëá™Âä®ËØ≠Èü≥ËØÜÂà´', 'Â§öËØ≠Ë®ÄÊîØÊåÅ', 'Ê†∑ÂºèÊ®°Êùø', 'ÂÆûÊó∂È¢ÑËßà', 'Êó†ÈôêÂà∂‰ΩøÁî®'],
    reviews: [
      { id: 3, user: 'ËßÜÈ¢ëÂçö‰∏ª', rating: 5, comment: 'ËØÜÂà´ÁéáÂæàÈ´òÔºåÊ†∑Âºè‰πüÂæàÊºÇ‰∫Æ', date: '2024-01-18' }
    ],
    changelog: [
      { version: '1.5.2', date: '2024-01-18', changes: ['‰øÆÂ§çÊ†∑Âºèbug', 'ÊèêÂçáËØÜÂà´ÂáÜÁ°ÆÁéá'] }
    ]
  },
  {
    id: 3,
    name: 'Â§öÂπ≥Âè∞‰∏ÄÈîÆÂèëÂ∏É',
    author: 'ÂèëÂ∏ÉÂä©Êâã',
    version: '3.0.1',
    icon: 'https://via.placeholder.com/60x60/45B7D1/FFFFFF?text=ÂèëÂ∏É',
    description: '‰∏ÄÈîÆÂèëÂ∏ÉÂà∞10+‰∏ªÊµÅÂπ≥Âè∞ÔºåÁúÅÊó∂È´òÊïà',
    longDescription: 'ÊîØÊåÅÊäñÈü≥„ÄÅÂø´Êâã„ÄÅBÁ´ô„ÄÅÂ∞èÁ∫¢‰π¶„ÄÅÂæÆÂçöÁ≠â10+‰∏ªÊµÅÂπ≥Âè∞ÁöÑ‰∏ÄÈîÆÂèëÂ∏É„ÄÇËá™Âä®ÈÄÇÈÖçÂêÑÂπ≥Âè∞Ê†ºÂºèË¶ÅÊ±ÇÔºåÊîØÊåÅÂÆöÊó∂ÂèëÂ∏ÉÔºåÊâπÈáèÊìç‰ΩúÔºåÂ§ßÂ§ßÊèêÂçáÂèëÂ∏ÉÊïàÁéá„ÄÇ',
    status: 'installed',
    type: 'premium',
    price: 59.9,
    rating: 4.9,
    downloads: 28900,
    users: 15600,
    categories: ['Âπ≥Âè∞ÈõÜÊàê', 'ÊïàÁéáÂ∑•ÂÖ∑'],
    features: ['10+Âπ≥Âè∞ÊîØÊåÅ', 'ÂÆöÊó∂ÂèëÂ∏É', 'ÊâπÈáèÊìç‰Ωú', 'Ê†ºÂºèËá™Âä®ÈÄÇÈÖç', 'Êó†ÈôêÂà∂ÂèëÂ∏É'],
    licenseStatus: { status: 'trial', expiresAt: '2024-02-01' },
    reviews: [
      { id: 4, user: 'MCNÊú∫ÊûÑ', rating: 5, comment: 'ÊïàÁéáÊèêÂçá10ÂÄçÔºÅ', date: '2024-01-16' }
    ],
    changelog: [
      { version: '3.0.1', date: '2024-01-19', changes: ['Êñ∞Â¢ûÂ∞èÁ∫¢‰π¶ÊîØÊåÅ', '‰ºòÂåñÂèëÂ∏ÉÊµÅÁ®ã'] }
    ]
  }
])

const installedPluginList = ref([
  { id: 1, name: 'ÊäñÈü≥ÁÉ≠ÁÇπËøΩË∏™Âô®', version: '2.1.0', status: 'enabled' },
  { id: 5, name: 'Á´ûÂìÅÂàÜÊûêÂô®', version: '1.2.0', status: 'enabled' },
  { id: 7, name: 'Â∞ÅÈù¢Ê®°ÊùøÂ∫ì', version: '3.5.0', status: 'disabled' }
])

// ËÆ°ÁÆóÂ±ûÊÄß
const filteredPlugins = computed(() => {
  let result = plugins.value

  // ÊêúÁ¥¢ËøáÊª§
  if (searchQuery.value) {
    result = result.filter(plugin => 
      plugin.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
      plugin.description.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
      plugin.features.some(feature => feature.toLowerCase().includes(searchQuery.value.toLowerCase()))
    )
  }

  // ÂàÜÁ±ªËøáÊª§
  if (selectedCategory.value) {
    result = result.filter(plugin => 
      plugin.categories.includes(selectedCategory.value)
    )
  }

  // ‰ª∑Ê†ºËøáÊª§
  if (priceFilter.value && priceFilter.value !== 'all') {
    result = result.filter(plugin => plugin.type === priceFilter.value)
  }

  // ÊéíÂ∫è
  switch (sortBy.value) {
    case 'rating':
      result.sort((a, b) => b.rating - a.rating)
      break
    case 'downloads':
      result.sort((a, b) => b.downloads - a.downloads)
      break
    case 'newest':
      result.sort((a, b) => new Date(b.changelog[0].date) - new Date(a.changelog[0].date))
      break
    default:
      result.sort((a, b) => b.downloads - a.downloads)
  }

  return result
})

// ÊñπÊ≥ï
const getStatusType = (status) => {
  const types = {
    'available': 'success',
    'installed': 'info',
    'update': 'warning'
  }
  return types[status] || 'info'
}

const installPlugin = async (plugin) => {
  const actionText = plugin.type === 'premium' ? 'ÂºÄÂßãËØïÁî®' : 'ÂÆâË£Ö'
  const confirmText = plugin.type === 'premium' ? 
    `Á°ÆÂÆöË¶ÅÂºÄÂßãËØïÁî® "${plugin.name}" Êèí‰ª∂ÂêóÔºüËØïÁî®Êúü‰∏∫7Â§©„ÄÇ` :
    `Á°ÆÂÆöË¶ÅÂÆâË£Ö "${plugin.name}" Êèí‰ª∂ÂêóÔºü`
    
  try {
    await ElMessageBox.confirm(
      confirmText,
      actionText + 'Êèí‰ª∂',
      { confirmButtonText: actionText, cancelButtonText: 'ÂèñÊ∂à' }
    )
    
    installing.value = plugin.id
    
    await pluginService.installPlugin(plugin.id)
    ElMessage.success(plugin.type === 'premium' ? 'ËØïÁî®ÂºÄÂßãÊàêÂäüÔºÅ' : 'Êèí‰ª∂ÂÆâË£ÖÊàêÂäüÔºÅ')
    
    // ÈáçÊñ∞Âä†ËΩΩÊèí‰ª∂ÂàóË°®
    loadPlugins()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('Êìç‰ΩúÂ§±Ë¥•Ôºö' + error.message)
    }
  } finally {
    installing.value = null
  }
}

const uninstallPlugin = async (plugin) => {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂç∏ËΩΩ "${plugin.name}" Êèí‰ª∂ÂêóÔºü`,
      'Âç∏ËΩΩÊèí‰ª∂',
      { confirmButtonText: 'Âç∏ËΩΩ', cancelButtonText: 'ÂèñÊ∂à' }
    )
    
    uninstalling.value = plugin.id
    
    await pluginService.uninstallPlugin(plugin.id)
    ElMessage.success('Êèí‰ª∂Âç∏ËΩΩÊàêÂäüÔºÅ')
    
    // ÈáçÊñ∞Âä†ËΩΩÊèí‰ª∂ÂàóË°®
    loadPlugins()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('Âç∏ËΩΩÂ§±Ë¥•Ôºö' + error.message)
    }
  } finally {
    uninstalling.value = null
  }
}

const purchasePlugin = async (plugin) => {
  selectedPluginForPurchase.value = plugin
  showPurchaseDialog.value = true
}

// Â§ÑÁêÜË¥≠‰π∞ÂÆåÊàê
const handlePurchaseComplete = async (result) => {
  showPurchaseDialog.value = false
  selectedPluginForPurchase.value = null
  
  if (result.success) {
    ElMessage.success(`ÊàêÂäüË¥≠‰π∞Êèí‰ª∂: ${result.plugin.name}`)
    await loadPlugins()
  }
}

// Â§ÑÁêÜË¥≠‰π∞ÂèñÊ∂à
const handlePurchaseCancel = () => {
  showPurchaseDialog.value = false
  selectedPluginForPurchase.value = null
}

// ÂºÄÂßãËØïÁî®
const startTrial = async (plugin) => {
  try {
    installing.value = plugin.id
    const result = await pluginService.startTrial(plugin.id)
    
    if (result.success) {
      ElMessage.success(`ÂºÄÂßãËØïÁî®Êèí‰ª∂: ${plugin.name}ÔºåËØïÁî®Êúü7Â§©`)
      await loadPlugins()
    } else {
      ElMessage.error(result.error || 'ÂºÄÂßãËØïÁî®Â§±Ë¥•')
    }
  } catch (error) {
    console.error('ÂºÄÂßãËØïÁî®Â§±Ë¥•:', error)
    ElMessage.error('ÂºÄÂßãËØïÁî®Â§±Ë¥•')
  } finally {
    installing.value = null
  }
}

const renewPlugin = async (plugin) => {
  try {
    const { value: licenseKey } = await ElMessageBox.prompt(
      `Áª≠Ë¥π "${plugin.name}" Êèí‰ª∂\n‰ª∑Ê†ºÔºö¬•${plugin.price}\n\nËØ∑ËæìÂÖ•Êñ∞ÁöÑËÆ∏ÂèØËØÅÂØÜÈí•Ôºö`,
      'Áª≠Ë¥πÊèí‰ª∂',
      {
        confirmButtonText: 'Á°ÆËÆ§Áª≠Ë¥π',
        cancelButtonText: 'ÂèñÊ∂à',
        inputPattern: /^[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}-[A-Z0-9]{5}$/,
        inputErrorMessage: 'ËØ∑ËæìÂÖ•Ê≠£Á°ÆÊ†ºÂºèÁöÑËÆ∏ÂèØËØÅÂØÜÈí• (XXXXX-XXXXX-XXXXX-XXXXX-XXXXX)'
      }
    )
    
    await pluginService.purchasePlugin(plugin.id, licenseKey)
    ElMessage.success('Áª≠Ë¥πÊàêÂäüÔºÅ')
    
    // ÈáçÊñ∞Âä†ËΩΩÊèí‰ª∂ÂàóË°®
    loadPlugins()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('Áª≠Ë¥πÂ§±Ë¥•Ôºö' + error.message)
    }
  }
}

const updatePlugin = (plugin) => {
  ElMessage.success(`Ê≠£Âú®Êõ¥Êñ∞ ${plugin.name}...`)
  setTimeout(() => {
    plugin.status = 'installed'
    ElMessage.success('Êèí‰ª∂Êõ¥Êñ∞ÊàêÂäüÔºÅ')
  }, 1500)
}

const viewPluginDetails = (plugin) => {
  selectedPlugin.value = plugin
  detailDialogVisible.value = true
}

const handleCategoryChange = (tab) => {
  selectedCategory.value = tab.name
}

const installSelectedPlugin = async () => {
  if (selectedPlugin.value) {
    await installPlugin(selectedPlugin.value)
    detailDialogVisible.value = false
  }
}

const togglePlugin = (plugin) => {
  plugin.status = plugin.status === 'enabled' ? 'disabled' : 'enabled'
  ElMessage.success(plugin.status === 'enabled' ? 'Êèí‰ª∂Â∑≤ÂêØÁî®' : 'Êèí‰ª∂Â∑≤Á¶ÅÁî®')
}

const managePlugins = () => {
  ElMessage.info('Êèí‰ª∂ÁÆ°ÁêÜÂäüËÉΩÂºÄÂèë‰∏≠...')
}

// Ëé∑ÂèñÊèí‰ª∂ÊèèËø∞
const getPluginDescription = (plugin) => {
  const descriptions = {
    'basic_ai_writer': 'Âü∫Á°ÄAIÂÜô‰ΩúÂäüËÉΩÔºåÊîØÊåÅÁÆÄÂçïÊñáÊú¨ÁîüÊàêÂíåÊ∂¶Ëâ≤',
    'basic_image_tools': 'Âü∫Á°ÄÂõæÁâáÂ§ÑÁêÜÂ∑•ÂÖ∑ÔºåÊîØÊåÅÊ†ºÂºèËΩ¨Êç¢ÂíåÁÆÄÂçïÁºñËæë',
    'basic_video_tools': 'Âü∫Á°ÄËßÜÈ¢ëÂ§ÑÁêÜÂ∑•ÂÖ∑ÔºåÊîØÊåÅÊ†ºÂºèËΩ¨Êç¢ÂíåÁÆÄÂçïÂâ™Ëæë',
    'pro_ai_writer': '‰∏ì‰∏öAIÂÜô‰ΩúÂä©ÊâãÔºåÊîØÊåÅÂ§öËØ≠Ë®ÄÂíåSEO‰ºòÂåñ',
    'pro_auto_editor': 'Êô∫ËÉΩËá™Âä®Ââ™ËæëÂ∑•ÂÖ∑ÔºåAIÈ©±Âä®ÁöÑËßÜÈ¢ëÂà∂‰Ωú',
    'pro_cover_designer': '‰∏ì‰∏öÂ∞ÅÈù¢ËÆæËÆ°Â∑•ÂÖ∑ÔºåAIÁîüÊàêÁ≤æÁæéÂ∞ÅÈù¢',
    'pro_hot_predictor': 'ÁÉ≠ÁÇπÈ¢ÑÊµãÂàÜÊûêÂ∑•ÂÖ∑ÔºåÊï∞ÊçÆÈ©±Âä®ÁöÑÂÜÖÂÆπÁ≠ñÁï•',
    'pro_batch_processor': 'Êô∫ËÉΩÊâπÈáèÂ§ÑÁêÜÂ∑•ÂÖ∑ÔºåËá™Âä®ÂåñÂ∑•‰ΩúÊµÅÁ®ã'
  }
  return descriptions[plugin.id] || 'ÊöÇÊó†ÊèèËø∞'
}

// Âä†ËΩΩÊèí‰ª∂ÂàóË°®
const loadPlugins = async () => {
  try {
    const plugins = pluginService.getAvailablePlugins()
    availablePlugins.value = plugins
    
    // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
    totalPlugins.value = plugins.length
    installedPlugins.value = plugins.filter(p => p.installed).length
    avgRating.value = 4.7 // Ê®°ÊãüÂπ≥ÂùáËØÑÂàÜ
    trendingPlugins.value = plugins.slice(0, 3) // Ââç3‰∏™‰Ωú‰∏∫ÁÉ≠Èó®Êèí‰ª∂
  } catch (error) {
    ElMessage.error('Âä†ËΩΩÊèí‰ª∂ÂàóË°®Â§±Ë¥•Ôºö' + error.message)
  }
}

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Âä†ËΩΩÊï∞ÊçÆ
onMounted(() => {
  loadPlugins()
})
</script>

<style scoped>
.plugin-market {
  padding: 20px;
}

.market-stats {
  margin-bottom: 30px;
}

.stat-card {
  text-align: center;
}

.stat-content {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.icon {
  font-size: 32px;
}

.data .number {
  font-size: 24px;
  font-weight: bold;
  color: #409eff;
}

.data .label {
  font-size: 14px;
  color: #666;
}

.search-section {
  margin-bottom: 30px;
}

.plugins-grid {
  margin-bottom: 30px;
}

.plugin-card {
  margin-bottom: 20px;
  transition: transform 0.3s;
}

.plugin-card:hover {
  transform: translateY(-5px);
}

.premium-plugin {
  border: 2px solid #f39c12;
  position: relative;
}

.premium-plugin::before {
  content: 'üíé';
  position: absolute;
  top: -8px;
  right: -8px;
  background: #f39c12;
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  z-index: 1;
}

.plugin-header {
  display: flex;
  align-items: center;
  padding: 15px;
  border-bottom: 1px solid #eee;
}

.plugin-badges {
  display: flex;
  flex-direction: column;
  gap: 5px;
  margin-left: auto;
}

.plugin-icon {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  margin-right: 15px;
}

.plugin-info h3 {
  margin: 0 0 5px 0;
  font-size: 16px;
}

.author {
  margin: 0;
  font-size: 12px;
  color: #666;
}

.plugin-body {
  padding: 15px;
}

.plugin-price {
  margin: 10px 0;
  padding: 8px;
  background: #fff7e6;
  border-radius: 4px;
  border-left: 3px solid #f39c12;
}

.price {
  font-size: 18px;
  font-weight: bold;
  color: #f39c12;
  margin-right: 10px;
}

.trial-info {
  font-size: 12px;
  color: #666;
}

.plugin-limitations {
  margin-top: 10px;
  padding: 6px 8px;
  background: #f0f9ff;
  border-radius: 4px;
  border-left: 3px solid #409eff;
}

.description {
  margin: 0 0 15px 0;
  font-size: 14px;
  color: #666;
  line-height: 1.5;
}

.plugin-stats {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  font-size: 12px;
  color: #999;
}

.stat {
  display: flex;
  align-items: center;
  gap: 5px;
}

.categories {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

.category-tag {
  margin: 2px;
}

.plugin-footer {
  padding: 15px;
  border-top: 1px solid #eee;
  display: flex;
  gap: 10px;
}

.plugin-detail {
  padding: 20px;
}

.detail-header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
}

.detail-icon {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  margin-right: 20px;
}

.detail-info h2 {
  margin: 0 0 10px 0;
}

.detail-author, .detail-version {
  margin: 5px 0;
  color: #666;
}

.detail-content {
  margin-top: 20px;
}

.reviews, .changelog {
  margin-top: 20px;
}

.review, .version {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.reviewer {
  font-weight: bold;
}

.review-date {
  font-size: 12px;
  color: #999;
}

.installed-section {
  margin-top: 30px;
}
</style>