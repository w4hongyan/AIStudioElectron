<template>
  <el-row :gutter="24" class="main-layout">
    <!-- Left Column: Control Panel -->
    <el-col :span="6">
      <el-card class="feature-card control-panel">
        <template #header>
          <div class="card-header">
            <span>üé¨ AI ÂΩ±ËßÜÂåñÁîü‰∫ßÂäõÂ∑•ÂÖ∑</span>
          </div>
        </template>
        
        <el-form :model="form" label-position="top">
          <el-form-item label="È°πÁõÆÊñá‰ª∂Â§π">
            <el-input v-model="projectPath" placeholder="Êú™ËÆæÁΩÆ" readonly>
              <template #append>
                <el-button @click="selectProjectFolder">ÈÄâÊã©...</el-button>
              </template>
            </el-input>
          </el-form-item>
          <el-form-item label="ÊïÖ‰∫ãÊ†∏ÂøÉ‰∏ªÈ¢ò">
            <el-input
              v-model="form.topic"
              type="textarea"
              :rows="3"
              placeholder="‰æãÂ¶ÇÔºö‰∏Ä‰∏™Á®ãÂ∫èÂëòÂú®ËµõÂçöÊúãÂÖãÈÉΩÂ∏Ç‰∏≠ÂØªÊâæ‰∏¢Â§±ÁöÑÊï∞Â≠óÁå´"
            />
          </el-form-item>

          <el-collapse v-model="activeCollapse" class="details-collapse">
            <el-collapse-item title="È´òÁ∫ßÂàõ‰ΩúÂèÇÊï∞" name="1">
              <el-form-item label="‰∏ªËßíËÆæÂÆö (ÂèØÈÄâ)">
                <el-input
                  v-model="form.characterBio"
                  type="textarea"
                  :rows="3"
                  placeholder="‰∏ªËßíÂßìÂêç„ÄÅË∫´‰ªΩ„ÄÅÊÄßÊ†º„ÄÅÁõÆÊ†áÁ≠â"
                />
              </el-form-item>
              <el-form-item label="ÊïÖ‰∫ãÂ§ßÁ∫≤ (ÂèØÈÄâ)">
                <el-input
                  v-model="form.storyOutline"
                  type="textarea"
                  :rows="5"
                  placeholder="ÊïÖ‰∫ãÁöÑËµ∑Âõ†„ÄÅÁªèËøá„ÄÅÈ´òÊΩÆ„ÄÅÁªìÂ±Ä"
                />
              </el-form-item>
              <el-form-item label="ÊåáÂÆöÂú∫ÊôØ (ÂèØÈÄâ)">
                <el-input
                  v-model="form.specificScenes"
                  type="textarea"
                  :rows="3"
                  placeholder="Â∏åÊúõÂøÖÈ°ªÂá∫Áé∞ÁöÑÂÖ∑‰ΩìÂú∫ÊôØÊàñÊÉÖËäÇÔºåÊØèË°å‰∏Ä‰∏™"
                />
              </el-form-item>
              <el-form-item label="Ë¥üÂêëÊèêÁ§∫ËØç (ÂèØÈÄâ)">
                <el-input
                  v-model="form.negativePrompt"
                  type="textarea"
                  :rows="2"
                  placeholder="‰æãÂ¶ÇÔºöÈÅøÂÖçÂá∫Áé∞Êö¥Âäõ„ÄÅË°ÄËÖ•ÂÜÖÂÆπ"
                />
              </el-form-item>
            </el-collapse-item>
          </el-collapse>

          <el-form-item label="ÈÄâÊã©ËßÜÈ¢ëÈ£éÊ†º">
            <el-select v-model="form.style" placeholder="ËØ∑ÈÄâÊã©È£éÊ†º" style="width: 100%;">
              <el-option label="ËµõÂçöÊúãÂÖã" value="cyberpunk" />
              <el-option label="ÁßëÂπªÊú™Êù•" value="sci-fi" />
              <el-option label="ÂõΩÈ£éÂ•áÂπª" value="fantasy-guofeng" />
              <el-option label="Ê∏©ÊÉÖÊó•Â∏∏" value="slice-of-life" />
            </el-select>
          </el-form-item>
          <el-form-item label="È¢Ñ‰º∞ÈïúÂ§¥Êï∞">
            <el-input-number v-model="form.shots" :min="3" :max="20" style="width: 100%;" />
          </el-form-item>
          
          <el-form-item>
            <el-row :gutter="10" style="width: 100%;">
              <el-col :span="12">
                <el-button :icon="FolderOpened" @click="loadProject" style="width: 100%;">Âä†ËΩΩÈ°πÁõÆ</el-button>
              </el-col>
              <el-col :span="12">
                <el-button type="primary" :icon="FolderAdd" @click="saveProject" style="width: 100%;">‰øùÂ≠òÈ°πÁõÆ</el-button>
              </el-col>
            </el-row>
          </el-form-item>

          <el-form-item>
            <el-button type="primary" @click="generateScript" :loading="loading" size="large" style="width: 100%;">
              <el-icon style="margin-right: 8px;"><MagicStick /></el-icon>
              {{ loading ? 'AI Ê≠£Âú®ÂÖ®ÂäõÂàõ‰Ωú‰∏≠...' : 'ÁîüÊàêÂØºÊºîÁ∫ßËÑöÊú¨' }}
            </el-button>
          </el-form-item>
        </el-form>
      </el-card>
    </el-col>

    <!-- Right Column: Results -->
    <el-col :span="18">
      <div class="result-container" v-loading="loading" element-loading-text="AIÊÄùËÄÉ‰∏≠ÔºåËØ∑Á®çÂÄô...">
        <div v-if="!result" class="placeholder">
          <el-empty description="Âú®Â∑¶‰æßËæìÂÖ•Âàõ‰ΩúË¶ÅÊ±ÇÔºåÂºÄÂßãÊÇ®ÁöÑAIÂΩ±ËßÜ‰πãÊóÖ" />
        </div>
        <div v-else>
          <el-row :gutter="20">
            <el-col :span="8">
              <el-card class="result-card">
                <template #header>
                  <div class="card-header-content">
                    <span>ÊïÖ‰∫ãÁÆÄ‰ªã</span>
                    <el-button type="primary" :icon="Refresh" circle plain size="small" @click="regeneratePart('synopsis')" />
                  </div>
                </template>
                <el-input v-model="result.synopsis" type="textarea" autosize class="result-text-input" />
              </el-card>
            </el-col>
            <el-col :span="8">
              <el-card class="result-card">
                <template #header>
                  <div class="card-header-content">
                    <span>Âú∫ÊôØÈ¢ÑËÆæ</span>
                    <el-button type="primary" :icon="Refresh" circle plain size="small" @click="regeneratePart('scenePreset')" />
                  </div>
                </template>
                <el-input v-model="result.scenePreset" type="textarea" autosize class="result-text-input" />
              </el-card>
            </el-col>
            <el-col :span="8">
              <el-card class="result-card">
                <template #header>
                  <div class="card-header-content">
                    <span>‰∫∫Áâ©È¢ÑËÆæ</span>
                    <el-button type="primary" :icon="Refresh" circle plain size="small" @click="regeneratePart('characterPreset')" />
                  </div>
                </template>
                <el-input v-model="result.characterPreset" type="textarea" autosize class="result-text-input" />
              </el-card>
            </el-col>
          </el-row>
          
          <el-card class="result-card table-card">
            <template #header>
              <div class="card-header-content">
                <span>ÂàÜÈïúÂàóË°®</span>
                <el-button type="success" :icon="Download" circle plain @click="exportDataAsXLSX" />
              </div>
            </template>
            <el-table :data="result.shots" stripe style="width: 100%">
              <el-table-column prop="timeline" label="Êó∂Èó¥ËΩ¥" width="100" />
              <el-table-column prop="character" label="‰∫∫Áâ©" width="120">
                <template #default="scope">
                  <el-input v-model="scope.row.character" type="textarea" autosize />
                </template>
              </el-table-column>
              <el-table-column prop="shot" label="ÈïúÂ§¥ÊèèËø∞" width="250">
                <template #default="scope">
                  <el-input v-model="scope.row.shot" type="textarea" autosize />
                </template>
              </el-table-column>
              <el-table-column prop="t2i_prompt" label="ÊñáÁîüÂõæÊèêÁ§∫ËØç">
                <template #default="scope">
                  <el-input v-model="scope.row.t2i_prompt" type="textarea" autosize />
                </template>
              </el-table-column>
              <el-table-column prop="i2v_prompt" label="ÂõæÁîüËßÜÈ¢ëÊèêÁ§∫ËØç">
                <template #default="scope">
                  <el-input v-model="scope.row.i2v_prompt" type="textarea" autosize />
                </template>
              </el-table-column>
              <el-table-column label="Êìç‰Ωú" width="80" fixed="right">
                <template #default="scope">
                  <el-button type="primary" :icon="Refresh" circle plain size="small" @click="regeneratePart('shot', scope.$index)" />
                </template>
              </el-table-column>
              <el-table-column label="Â™í‰ΩìÈ¢ÑËßà" width="180" fixed="right">
                <template #default="scope">
                  <div class="media-container">
                    <video v-if="scope.row.videoUrl" :src="scope.row.videoUrl" class="shot-video" controls />
                    <el-image
                      v-else
                      :src="scope.row.imageUrl"
                      fit="cover"
                      class="shot-image"
                      :preview-src-list="scope.row.imageUrl ? [scope.row.imageUrl] : []"
                      hide-on-click-modal
                    >
                      <template #error>
                        <div class="image-slot">
                          <el-icon><Picture /></el-icon>
                        </div>
                      </template>
                    </el-image>
                    <div class="media-overlay">
                      <div class="media-actions">
                        <el-button
                          type="warning"
                          :icon="PictureRounded"
                          circle
                          size="small"
                          @click="generateImageForRow(scope.$index)"
                          :loading="scope.row.isGeneratingImage"
                          title="ÁîüÊàêÂõæÁâá"
                        />
                        <el-button
                          type="danger"
                          :icon="VideoCamera"
                          circle
                          size="small"
                          @click="generateVideoForRow(scope.$index)"
                          :loading="scope.row.isGeneratingVideo"
                          :disabled="!scope.row.imageUrl"
                          title="ÁîüÊàêËßÜÈ¢ë"
                        />
                      </div>
                    </div>
                  </div>
                </template>
              </el-table-column>
            </el-table>
          </el-card>
        </div>
      </div>
    </el-col>
  </el-row>
</template>

<script setup>
import { ref, reactive } from 'vue';
import { Refresh, Download, Picture, PictureRounded, FolderAdd, FolderOpened, VideoCamera } from '@element-plus/icons-vue';
import * as XLSX from 'xlsx';
import { ElMessage } from 'element-plus';

const projectPath = ref('');
const activeCollapse = ref([]);
const form = reactive({
  topic: '',
  characterBio: '',
  storyOutline: '',
  specificScenes: '',
  style: 'cyberpunk',
  shots: 5,
  negativePrompt: '',
});
const loading = ref(false);
const result = ref(null);

const generateScript = () => {
  if (!form.topic) {
    ElMessage.warning('ËØ∑ËæìÂÖ•ÊïÖ‰∫ãÊ†∏ÂøÉ‰∏ªÈ¢òÔºÅ');
    return;
  }
  console.log('Generating with form data:', form);
  loading.value = true;
  result.value = null;

  // Simulate AI API call
  setTimeout(() => {
    result.value = {
      synopsis: 'Âú®2077Âπ¥ÁöÑÈúìËôπÈÉΩÂ∏Ç‚ÄúÂ§ú‰πãÂüé‚ÄùÔºå‰∏ÄÂêçÂ≠§Áã¨ÁöÑÁ®ãÂ∫èÂëò‚ÄúK‚Äù‰∏∫‰∫ÜÂØªÊâæ‰ªñÊÑèÂ§ñ‰∏¢Â§±ÁöÑÊï∞Â≠óÂÆ†Áâ©Áå´‚ÄúÊØîÁâπ‚ÄùÔºåË∏è‰∏ä‰∫Ü‰∏ÄÊÆµÁ©øË∂äÊï∞ÊçÆ‰∏éÁé∞ÂÆûËæπÁïåÁöÑÂç±Èô©ÊóÖÁ®ã„ÄÇ',
      scenePreset: 'È´òÊ•ºÊûóÁ´ã„ÄÅÈúìËôπÈó™ÁÉÅÁöÑËµõÂçöÊúãÂÖãÈÉΩÂ∏ÇÂ§úÊôØÔºåÁ©∫‰∏≠‰∫§ÈÄöÁ©øÊ¢≠ÔºåÂ∑®ÂûãÂÖ®ÊÅØÂπøÂëäÁâåÈó™ÁÉÅ„ÄÇË°óÈÅìÂ±ÇÈù¢ÊΩÆÊπø„ÄÅÊã•Êå§ÔºåÂÖÖÊª°Ëí∏Ê±ΩÂíåÂêÑÂºèÂêÑÊ†∑ÁöÑ‰∫∫„ÄÇ',
      characterPreset: '‰∏ªËßí‚ÄúK‚ÄùÔºö20Â§öÂ≤ÅÔºåÊäÄÊúØÂÆÖÔºåÁ©øÁùÄÂäüËÉΩÊÄßÂ§πÂÖãÔºåÁúºÁ•ûÁï•Â∏¶Áñ≤ÊÉ´‰ΩÜÂÖÖÊª°ÂÜ≥ÂøÉ„ÄÇÊï∞Â≠óÁå´‚ÄúÊØîÁâπ‚ÄùÔºöÁî±Á∫ØÁ≤πÁöÑÊï∞ÊçÆÊûÑÊàêÔºåÂΩ¢ÊÄÅÂèØÂèòÔºåÂèëÂá∫ÊüîÂíåÁöÑËìùÂÖâ„ÄÇ',
      shots: [
        { timeline: '0-5s', character: 'Êó†', shot: 'ÂπøËßíÔºåÂ§ú‰πãÂüéÂÖ®ÊôØÔºåÈúìËôπÁÅØÈõ®Â§úÔºåÈïúÂ§¥ÁºìÁºìÊé®ÂêëKÁöÑÂÖ¨ÂØìÁ™óÊà∑„ÄÇ', t2i_prompt: 'cyberpunk city, rainy night, neon lights, wide angle, cinematic, view from above, blade runner style', i2v_prompt: 'slow zoom in, rain dripping on glass', imageUrl: '', isGeneratingImage: false, videoUrl: '', isGeneratingVideo: false },
        { timeline: '5-10s', character: 'K', shot: '‰∏≠ÊôØÔºåKÂú®ÁîµËÑëÂâçÔºåÂ±èÂπï‰∏äÊòæÁ§∫ÁùÄ‚ÄúÊØîÁâπ‚ÄùÁöÑÂèØÁà±‰ª£Á†ÅÂΩ¢Ë±°ÔºåÁ™ÅÁÑ∂Â±èÂπï‰∏ÄÈªë„ÄÇ', t2i_prompt: 'a young programmer in a dark room, multiple monitors, holographic digital cat on screen, surprised expression, cinematic lighting', i2v_prompt: 'screen flickers and goes black, cat disappears', imageUrl: '', isGeneratingImage: false, videoUrl: '', isGeneratingVideo: false },
        { timeline: '10-15s', character: 'K', shot: 'ÁâπÂÜôÔºåKÊà¥‰∏äÁ•ûÁªèÊé•Âè£ËÆæÂ§áÔºåÁúºÁ•ûÂùöÂÆö„ÄÇ', t2i_prompt: 'close up, man putting on a neural interface headset, determined look, glowing blue lights on the device, detailed, sci-fi', i2v_prompt: 'subtle light glow effect, very slow forward dolly', imageUrl: '', isGeneratingImage: false, videoUrl: '', isGeneratingVideo: false },
        { timeline: '15-25s', character: 'K', shot: 'Âø´ÈÄüËíôÂ§™Â•áÔºåKÂú®Êï∞ÊçÆÊµÅ‰∏≠Á©øÊ¢≠ÔºåË∫≤ÈÅøÈò≤ÁÅ´Â¢ôÔºåËøΩË∏™‚ÄúÊØîÁâπ‚ÄùÁöÑË∏™Ëøπ„ÄÇ', t2i_prompt: 'man surfing on a stream of data, digital world, abstract, glowing lines, binary code, dodging red firewall barriers, motion blur', i2v_prompt: 'fast-paced camera movement, glitch effects, particle effects', imageUrl: '', isGeneratingImage: false, videoUrl: '', isGeneratingVideo: false },
        { timeline: '25-30s', character: 'K, ÊØîÁâπ', shot: 'ËøúÊôØÔºåKÂú®‰∏Ä‰∏™Â∑®Â§ßÁöÑÊï∞ÊçÆÊúçÂä°Âô®Ê†∏ÂøÉÊâæÂà∞‰∫ÜË¢´Âõ∞ÁöÑ‚ÄúÊØîÁâπ‚ÄùÔºå‰ªñ‰º∏Âá∫Êâã„ÄÇ', t2i_prompt: 'a man reaching his hand towards a small glowing digital cat trapped inside a massive, glowing server core, epic scale, volumetric lighting', i2v_prompt: 'camera slowly orbits, particles floating around the core', imageUrl: '', isGeneratingImage: false, videoUrl: '', isGeneratingVideo: false },
      ],
    };
    loading.value = false;
  }, 2000);
};

const regeneratePart = (part, index = -1) => {
  console.log(`Regenerating ${part} at index ${index}...`);
  // Simulate API call for regeneration
  setTimeout(() => {
    if (part === 'synopsis') {
      result.value.synopsis = 'ÔºàÊñ∞ÁîüÊàêÔºâ‰∏ÄÂêçÂèõÈÄÜÁöÑËµèÈáëÁåé‰∫∫ÔºåÂú®Ê∑∑‰π±ÁöÑÁÅ´ÊòüÊÆñÊ∞ëÂú∞ÔºåÂèëÁé∞‰∫Ü‰∏Ä‰∏™ÂèØËÉΩÈ¢†Ë¶ÜÊï¥‰∏™Â§™Èò≥Á≥ªÊùÉÂäõÊ†ºÂ±ÄÁöÑÂè§ËÄÅÂ§ñÊòüÁßòÂØÜ„ÄÇ';
    } else if (part === 'scenePreset') {
      result.value.scenePreset = 'ÔºàÊñ∞ÁîüÊàêÔºâÁ∫¢Ëâ≤Ê≤ôÊº†Ë¶ÜÁõñÁöÑÁÅ´ÊòüË°®Èù¢ÔºåÁÇπÁºÄÁùÄÈ•±ÁªèÈ£éÈúúÁöÑÁ©πÈ°∂ÊÆñÊ∞ëÂú∞„ÄÇÁ©∫Ê∞î‰∏≠Âº•Êº´ÁùÄÈìÅÈîàÂíåËá≠Ê∞ßÁöÑÂë≥ÈÅìÔºåËøúÂ§ÑÊòØÂ∑®Â§ßÁöÑËΩ®ÈÅìÁîµÊ¢Ø„ÄÇ';
    } else if (part === 'characterPreset') {
      result.value.characterPreset = 'ÔºàÊñ∞ÁîüÊàêÔºâ‰∏ªËßí‚ÄúËïæÂ®ú‚ÄùÔºö30Â§öÂ≤ÅÔºåË∫´ÊâãÁü´ÂÅ•ÔºåÁ©øÁùÄÁ£®ÊçüÁöÑÁöÆÂ§πÂÖãÔºåÈ©æÈ©∂ÁùÄ‰∏ÄËâòÁªèËøáÈùûÊ≥ïÊîπË£ÖÁöÑÊòüÈôÖÈ£ûËàπÔºåÁúºÁ•ûÊÑ§‰∏ñÂ´â‰øó‰ΩÜÂÜÖÂøÉÊ∏¥ÊúõÊ≠£‰πâ„ÄÇ';
    } else if (part === 'shot' && index !== -1) {
      result.value.shots[index] = {
        timeline: result.value.shots[index].timeline, // Keep timeline the same
        character: 'ÔºàÊñ∞ÔºâËïæÂ®ú',
        shot: 'ÔºàÊñ∞ÔºâÁâπÂÜôÔºåËïæÂ®úÁöÑÁîµÂ≠ê‰πâÁúºÊâ´ÊèèÁùÄ‰∏Ä‰∏™Âè§ËÄÅÁöÑÁü≥Á¢ëÔºåÊï∞ÊçÆÊµÅÂú®Â•πÁöÑËßÜÈáé‰∏≠Èó™Ëøá„ÄÇ',
        t2i_prompt: 'ÔºànewÔºâclose up, female cyborg\'s glowing eye scanning an ancient alien monolith, data streams overlaying her vision, cinematic, detailed',
        i2v_prompt: 'ÔºànewÔºâsubtle glowing and data stream effects'
      };
    }
  }, 1000);
};

const exportDataAsXLSX = () => {
  if (!result.value) {
    ElMessage.warning('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂÜÖÂÆπÔºÅ');
    return;
  }
  try {
    const wb = XLSX.utils.book_new();

    // --- Create Info Worksheet with Styles ---
    const infoData = [
      { Category: 'ÊïÖ‰∫ãÁÆÄ‰ªã', Content: result.value.synopsis },
      { Category: 'Âú∫ÊôØÈ¢ÑËÆæ', Content: result.value.scenePreset },
      { Category: '‰∫∫Áâ©È¢ÑËÆæ', Content: result.value.characterPreset },
    ];
    const wsInfo = XLSX.utils.json_to_sheet(infoData, { skipHeader: true });
    XLSX.utils.sheet_add_aoa(wsInfo, [['ÂàÜÁ±ª', 'ÂÜÖÂÆπ']], { origin: 'A1' });
    wsInfo['!cols'] = [{ wch: 15 }, { wch: 80 }];
    wsInfo['A1'].s = { font: { bold: true } };
    wsInfo['B1'].s = { font: { bold: true } };
    XLSX.utils.book_append_sheet(wb, wsInfo, 'Info');

    // --- Create Shots Worksheet with Styles ---
    const shotsData = result.value.shots.map(shot => ({
      'Êó∂Èó¥ËΩ¥': shot.timeline,
      '‰∫∫Áâ©': shot.character,
      'ÈïúÂ§¥ÊèèËø∞': shot.shot,
      'ÊñáÁîüÂõæÊèêÁ§∫ËØç': shot.t2i_prompt,
      'ÂõæÁîüËßÜÈ¢ëÊèêÁ§∫ËØç': shot.i2v_prompt,
    }));
    const wsShots = XLSX.utils.json_to_sheet(shotsData);
    const shotsCols = [
      { wch: 15 }, { wch: 20 }, { wch: 50 }, { wch: 60 }, { wch: 60 },
    ];
    wsShots['!cols'] = shotsCols;
    const headerCells = ['A1', 'B1', 'C1', 'D1', 'E1'];
    headerCells.forEach(cell => {
      if (wsShots[cell]) {
        wsShots[cell].s = { font: { bold: true } };
      }
    });
    XLSX.utils.book_append_sheet(wb, wsShots, 'Shots');

    // --- Write the file with a sanitized, topic-based name ---
    const sanitizeFilename = (name) => {
      if (!name) return 'ai-script';
      return name.replace(/[\/\\?%*:|"<>]/g, '_').substring(0, 50);
    };
    const filename = `${sanitizeFilename(form.topic)}.xlsx`;
    XLSX.writeFile(wb, filename);

    ElMessage.success({
      message: `ÊàêÂäüÂØºÂá∫Êñá‰ª∂Ôºö${filename}`,
      duration: 5000,
    });

  } catch (error) {
    console.error('Failed to export data as XLSX:', error);
    ElMessage.error('ÂØºÂá∫XLSXÂ§±Ë¥•ÔºÅ');
  }
};

const generateImageForRow = async (index) => {
  const shot = result.value.shots[index];
  if (!shot || !shot.t2i_prompt) {
    ElMessage.warning('ËØ•ÈïúÂ§¥Ê≤°ÊúâÊñáÁîüÂõæÊèêÁ§∫ËØçÔºÅ');
    return;
  }
  
  console.log(`Generating image for shot ${index} with prompt:`, shot.t2i_prompt);
  shot.isGeneratingImage = true;
  shot.imageUrl = '';

  // Simulate Text-to-Image API call
  await new Promise(resolve => setTimeout(resolve, 2500));
  
  const seed = shot.t2i_prompt.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
  const remoteUrl = `https://picsum.photos/seed/${seed}/1280/720`;
  
  if (projectPath.value) {
    try {
      const localPath = await window.electronAPI.downloadMedia({ url: remoteUrl, projectPath: projectPath.value, topic: form.topic });
      shot.imageUrl = `file://${localPath}`;
      ElMessage.success(`ÈïúÂ§¥ ${index + 1} ÂõæÁâáÂ∑≤ÁîüÊàêÂπ∂‰øùÂ≠òÔºÅ`);
    } catch (error) {
      console.error('Failed to download image:', error);
      ElMessage.error('ÂõæÁâá‰∏ãËΩΩÂ§±Ë¥•ÔºÅ');
      shot.imageUrl = remoteUrl; // Fallback to remote URL
    }
  } else {
    shot.imageUrl = remoteUrl;
    ElMessage.success(`ÈïúÂ§¥ ${index + 1} ÂõæÁâáÁîüÊàêÊàêÂäüÔºÅ`);
  }
  shot.isGeneratingImage = false;
};

const generateVideoForRow = async (index) => {
  const shot = result.value.shots[index];
  if (!shot || !shot.imageUrl) {
    ElMessage.warning('ËØ∑ÂÖà‰∏∫ËØ•ÈïúÂ§¥ÁîüÊàêÂõæÁâáÔºÅ');
    return;
  }
  
  console.log(`Generating video for shot ${index} with prompt:`, shot.i2v_prompt);
  shot.isGeneratingVideo = true;
  shot.videoUrl = '';

  // Simulate Image-to-Video API call
  await new Promise(resolve => setTimeout(resolve, 5000));
  
  const remoteUrl = 'https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/360/Big_Buck_Bunny_360_10s_1MB.mp4';

  if (projectPath.value) {
    try {
      const localPath = await window.electronAPI.downloadMedia({ url: remoteUrl, projectPath: projectPath.value, topic: form.topic });
      shot.videoUrl = `file://${localPath}`;
      ElMessage.success(`ÈïúÂ§¥ ${index + 1} ËßÜÈ¢ëÂ∑≤ÁîüÊàêÂπ∂‰øùÂ≠òÔºÅ`);
    } catch (error) {
      console.error('Failed to download video:', error);
      ElMessage.error('ËßÜÈ¢ë‰∏ãËΩΩÂ§±Ë¥•ÔºÅ');
      shot.videoUrl = remoteUrl; // Fallback to remote URL
    }
  } else {
    shot.videoUrl = remoteUrl;
    ElMessage.success(`ÈïúÂ§¥ ${index + 1} ËßÜÈ¢ëÁîüÊàêÊàêÂäüÔºÅ`);
  }
  shot.isGeneratingVideo = false;
};

const saveProject = () => {
  if (!form.topic && !result.value) {
    ElMessage.warning('Ê≤°ÊúâÂèØ‰øùÂ≠òÁöÑÂÜÖÂÆπÔºÅ');
    return;
  }
  try {
    const projectData = {
      form: form,
      result: result.value,
    };
    const dataStr = JSON.stringify(projectData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const sanitizeFilename = (name) => {
      if (!name) return 'ai-project';
      return name.replace(/[\/\\?%*:|"<>]/g, '_').substring(0, 50);
    };
    link.href = url;
    link.download = `${sanitizeFilename(form.topic)}.aiproj.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    ElMessage.success('È°πÁõÆÂ∑≤‰øùÂ≠òÔºÅ');
  } catch (error) {
    console.error('Failed to save project:', error);
    ElMessage.error('È°πÁõÆ‰øùÂ≠òÂ§±Ë¥•ÔºÅ');
  }
};

const loadProject = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.aiproj.json,application/json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (res) => {
      try {
        const projectData = JSON.parse(res.target.result);
        if (projectData.form && projectData.result) {
          // Manually update reactive object properties
          Object.assign(form, projectData.form);
          result.value = projectData.result;
          ElMessage.success(`È°πÁõÆ "${form.topic}" Â∑≤Âä†ËΩΩÔºÅ`);
        } else {
          ElMessage.error('Êó†ÊïàÁöÑÈ°πÁõÆÊñá‰ª∂Ê†ºÂºèÔºÅ');
        }
      } catch (error) {
        console.error('Failed to load project:', error);
        ElMessage.error('Âä†ËΩΩÈ°πÁõÆÂ§±Ë¥•ÔºÅ');
      }
    };
    reader.readAsText(file);
  };
  input.click();
};

const selectProjectFolder = async () => {
  const path = await window.electronAPI.selectDirectory();
  if (path) {
    projectPath.value = path;
    ElMessage.success(`È°πÁõÆÊñá‰ª∂Â§πÂ∑≤ËÆæÁΩÆ‰∏∫Ôºö${path}`);
  }
};
</script>

<style scoped>
.main-layout {
  height: 100%;
}
.control-panel, .result-container {
  /* height: calc(100vh - 108px); */ /* Removed fixed height to allow natural flow */
  display: flex;
  flex-direction: column;
}
.result-container {
  /* justify-content: center; */ /* Removed to allow content to start from top */
}
.placeholder {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}
.card-header {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-color-primary);
}

.card-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}
.result-card {
  margin-bottom: 20px;
  /* height: 150px; */ /* Removed fixed height to allow content to determine height */
  /* overflow-y: auto; */ /* Removed overflow to prevent scrollbars */
}
.result-text {
  font-size: 14px;
  line-height: 1.6;
}
.result-text-input .el-textarea__inner {
  box-shadow: none !important;
  border: 1px solid transparent;
  background-color: transparent;
  padding: 0;
  font-size: 14px;
  line-height: 1.6;
  color: var(--text-color-primary);
  resize: none;
}
.result-text-input .el-textarea__inner:hover {
  border-color: var(--border-color);
}
.result-text-input .el-textarea__inner:focus {
  border-color: var(--accent-color);
}
.table-card {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}
.el-table {
  --el-table-border-color: var(--border-color);
  --el-table-header-bg-color: #fafafa;
  --el-table-tr-bg-color: var(--card-bg-color);
  --el-table-row-hover-bg-color: #ecf5ff;
  --el-table-header-text-color: var(--text-color-secondary);
  border-radius: 8px;
  overflow: hidden;
}
.el-table th.el-table__cell {
  font-weight: 600;
  color: var(--text-color-secondary);
}
.media-container {
  position: relative;
  width: 160px;
  height: 100px;
  border-radius: 4px;
  overflow: hidden;
}
.shot-image, .shot-video {
  width: 100%;
  height: 100%;
  background-color: #f5f7fa;
  display: flex;
  justify-content: center;
  align-items: center;
  object-fit: cover;
}
.media-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.media-container:hover .media-overlay {
  opacity: 1;
}
.media-actions {
  display: flex;
  gap: 10px;
}
.image-slot {
  font-size: 24px;
  color: #c0c4cc;
}
.details-collapse {
  margin-bottom: 18px;
  border-top: none;
  border-bottom: none;
}
.details-collapse .el-collapse-item__header {
  border-bottom: none;
  font-size: 14px;
  font-weight: 500;
}
.details-collapse .el-collapse-item__wrap {
  border-bottom: none;
}
.details-collapse .el-collapse-item__content {
  padding-bottom: 0;
}
</style>
